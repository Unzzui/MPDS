{% extends "general/base.html" %}
{% block title %}Editar Rutina{% endblock %}
{% block content %}
<div class="container">
    <h1 class="title">Editar Rutina</h1>

    <!-- Formulario para editar la rutina -->
    <form method="POST" action="{{ url_for('routines.edit_routine_route', name=routine.name) }}">
        <!-- Campo para el nuevo nombre de la rutina -->
        <div class="form-group">
            <label for="routine-name">Nombre de la Rutina:</label>
            <input
                type="text"
                id="routine-name"
                name="name"
                value="{{ routine.name }}"
                class="form-control"
                required
            />
        </div>
        
        <div class="form-group">
            <label for="exercise-list">Ejercicios:</label>
            <div id="exercise-list">
                {% for exercise in routine.exercises %}
                <div class="exercise-item">
                    <!-- Etiqueta asociada al campo -->
                    <label for="exercise-{{ loop.index }}">Ejercicio {{ loop.index }}:</label>
                    
                    <!-- Depuración de valores comparados -->
                    
                    <!-- Dropdown para seleccionar ejercicios -->
                    <select id="exercise-{{ loop.index }}" name="exercises[]" class="form-control exercise-select" required>
                        <option value="">Selecciona un ejercicio</option>
                        {% for available_exercise in exercises %}
                        <option value="{{ available_exercise }}" 
                            {% if available_exercise|lower|trim == exercise|lower|trim %}selected{% endif %}>
                            {{ available_exercise }}
                        </option>
                        {% endfor %}
                    </select>
                    
                    <!-- Depuración después del <select> -->
                    
                    <!-- Botón para eliminar ejercicio -->
                    <button type="button" class="btn btn-danger remove-exercise">Eliminar</button>
                </div>
                {% endfor %}
            </div>
            <!-- Botón para agregar un nuevo ejercicio -->
            <button type="button" id="add-exercise" class="btn btn-secondary mt-3">Agregar Ejercicio</button>
        </div>
        

        <!-- Botones para guardar o cancelar -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            <a href="{{ url_for('routines.view_routines') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
<script>
    console.log("Ejercicios actuales:", {{ routine.exercises | tojson }});
</script>

<!-- Script para manejar la lista dinámica de ejercicios -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Obtener el contenedor de la lista de ejercicios y el botón de agregar
        const exerciseList = document.getElementById("exercise-list");
        const addExerciseBtn = document.getElementById("add-exercise");
        
        // Verificar que los elementos existen antes de proceder
        if (!exerciseList) {
            console.error("No se encontró el contenedor 'exercise-list'.");
            return;
        }
        if (!addExerciseBtn) {
            console.error("No se encontró el botón 'add-exercise'.");
            return;
        }

        // Convertir la lista de ejercicios disponibles a un formato JSON desde el backend
        const availableExercises = {{ exercises | tojson }};
        
        // Función para crear un nuevo elemento de ejercicio
        function createExerciseItem(selectedExercise = "") {
            const newExerciseItem = document.createElement("div");
            newExerciseItem.classList.add("exercise-item");

            // Generar las opciones del select dinámicamente
            let optionsHtml = `<option value="">Selecciona un ejercicio</option>`;
            availableExercises.forEach(exercise => {
                optionsHtml += `<option value="${exercise}" ${exercise === selectedExercise ? "selected" : ""}>${exercise}</option>`;
            });

            // Definir el contenido del nuevo elemento
            newExerciseItem.innerHTML = `
                <select name="exercises[]" class="form-control exercise-select" required>
                    ${optionsHtml}
                </select>
                <button type="button" class="btn btn-danger remove-exercise">Eliminar</button>
            `;

            // Agregar evento de eliminación al botón "Eliminar"
            newExerciseItem.querySelector(".remove-exercise").addEventListener("click", () => {
                exerciseList.removeChild(newExerciseItem);
            });

            return newExerciseItem;
        }

        // Evento para agregar un nuevo ejercicio al hacer clic en "Agregar Ejercicio"
        addExerciseBtn.addEventListener("click", () => {
            const newExerciseItem = createExerciseItem();
            exerciseList.appendChild(newExerciseItem);
        });

        // Manejar eliminación de ejercicios existentes
        document.querySelectorAll(".remove-exercise").forEach(button => {
            button.addEventListener("click", (event) => {
                const exerciseItem = event.target.closest(".exercise-item");
                if (exerciseItem) {
                    exerciseList.removeChild(exerciseItem);
                }
            });
        });
    });
</script>

{% endblock %}
